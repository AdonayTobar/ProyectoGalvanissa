<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes - Galvanissa</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        window.initializeApp = initializeApp;
        window.getAuth = getAuth;
        window.signInWithCustomToken = signInWithCustomToken;
        window.signInAnonymously = signInAnonymously;
        window.signOut = signOut;
        window.onAuthStateChanged = onAuthStateChanged;
        window.getFirestore = getFirestore;
        window.setLogLevel = setLogLevel;
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }

        .color-galvanissa {
            color: #293241;
        }

        .no-scroll {
            overflow: hidden;
        }
    </style>
    <link rel="manifest" href="manifest.json">
</head>

<body class="antialiased">
    <a id="top"></a>
    <div id="main-content">
        <header class="bg-white shadow-md sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <a href="index.html"
                        class="flex-shrink-0 text-xl font-extrabold text-indigo-600 tracking-tight transition duration-150 ease-in-out hover:text-indigo-800"
                        style="color: #293241;">Adonay Tobar</a>
                    <nav id="main-nav" class="hidden md:flex space-x-6 items-center">
                        <a href="index.html"
                            class="text-gray-600 hover:text-indigo-600 font-medium transition duration-150 ease-in-out">Precios</a>
                        <a href="clientes.html"
                            class="text-indigo-600 font-bold transition duration-150 ease-in-out">Clientes</a>
                        <button id="logout-button-desktop"
                            class="ml-4 px-4 py-2 text-sm font-semibold text-white bg-red-500 hover:bg-red-600 rounded-full shadow-lg transition duration-150 ease-in-out">Cerrar
                            Sesi√≥n</button>
                    </nav>
                    <div class="md:hidden flex items-center">
                        <button id="menu-toggle"
                            class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500 transition duration-150 ease-in-out"
                            aria-expanded="false">
                            <svg class="block h-6 w-6" id="icon-menu" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                            <svg class="hidden h-6 w-6" id="icon-close" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div id="mobile-menu" class="hidden md:hidden absolute w-full bg-white shadow-xl">
                <div class="pt-2 pb-3 space-y-1 px-4 border-t border-gray-100">
                    <a href="index.html"
                        class="block rounded-lg py-2 px-3 text-base font-medium text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">Precios</a>
                    <a href="clientes.html"
                        class="block rounded-lg py-2 px-3 text-base font-bold text-indigo-600 bg-indigo-50">Clientes</a>
                </div>
                <div class="pt-4 pb-2 border-t border-gray-100 px-4">
                    <button id="logout-button-mobile"
                        class="w-full text-left rounded-lg py-2 px-3 text-base font-semibold text-white bg-red-500 hover:bg-red-600 transition duration-150 ease-in-out">Cerrar
                        Sesi√≥n</button>
                </div>
            </div>
        </header>

        <main class="py-5 md:py-16">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center mb-10">
                    <h1 class="text-2xl font-extrabold text-gray-900 sm:text-5xl" style="color: #293241;">Gesti√≥n de
                        Clientes</h1>
                </div>

                <div class="grid grid-cols-4 gap-4 mb-8 justify-items-center">
                    <button onclick="openAddClientModal()"
                        class="w-16 h-16 bg-indigo-600 rounded-xl shadow-lg flex items-center justify-center text-white hover:bg-indigo-700 hover:scale-105 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                        </svg>
                    </button>
                    <button onclick="openCategoriesModal()"
                        class="w-16 h-16 bg-purple-600 rounded-xl shadow-lg flex items-center justify-center text-white hover:bg-purple-700 hover:scale-105 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                        </svg>
                    </button>
                    <button onclick="openSendModal()"
                        class="w-16 h-16 bg-purple-600 rounded-xl shadow-lg flex items-center justify-center text-white hover:bg-purple-700 hover:scale-105 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        <svg class="h-8 w-8" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg"
                            stroke="currentColor">
                            <path stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                                d="M30.133 1.552c-1.090-1.044-2.291-1.573-3.574-1.573-2.006 0-3.47 1.296-3.87 1.693-0.564 0.558-19.786 19.788-19.786 19.788-0.126 0.126-0.217 0.284-0.264 0.456-0.433 1.602-2.605 8.71-2.627 8.782-0.112 0.364-0.012 0.761 0.256 1.029 0.193 0.192 0.45 0.295 0.713 0.295 0.104 0 0.208-0.016 0.31-0.049 0.073-0.024 7.41-2.395 8.618-2.756 0.159-0.048 0.305-0.134 0.423-0.251 0.763-0.754 18.691-18.483 19.881-19.712 1.231-1.268 1.843-2.59 1.819-3.925-0.025-1.319-0.664-2.589-1.901-3.776z" />
                        </svg>

                    </button>
                    <button onclick="openChargeModal()"
                        class="w-16 h-16 bg-purple-600 rounded-xl shadow-lg flex items-center justify-center text-white hover:bg-purple-700 hover:scale-105 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                            class="h-8 w-8 text-white">
                            <polyline points="11 7 8 4 5 7" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                            <polyline points="13 17 16 20 19 17" stroke="currentColor" stroke-width="2"
                                stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M8 20V4M16 4V20" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                stroke-linejoin="round" />
                        </svg>

                    </button>
                </div>

                <div class="mb-6">
                    <div class="relative">
                        <input type="text" id="client-search"
                            placeholder="Buscar por nombre, apellidos, tel√©fono, direcci√≥n o categor√≠a..." class="w-full px-4 py-3 pl-12 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500
            focus:border-indigo-500 transition duration-150 shadow-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 absolute left-4 top-3.5 text-gray-400"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>

                <div id="clients-list" class="space-y-2"></div>
                <div id="no-clients-message" class="bg-white shadow-xl rounded-xl p-8 text-center hidden">
                    <div class="text-gray-400 mb-4"><svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto"
                            fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg></div>
                    <h3 class="text-lg font-medium text-gray-900">No hay clientes registrados</h3>
                    <p class="mt-2 text-gray-500">Comienza agregando tu primer cliente.</p>
                </div>
            </div>
        </main>

        <footer class="bg-gray-800 text-white py-6">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center text-sm text-gray-400">Cat√°logo de precios
                &copy; 2025. Adonay Tobar.</div>
        </footer>
    </div>

    <!-- MODAL AGREGAR CLIENTE -->
    <div id="add-client-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[100] flex items-center justify-center p-4">
        <div
            class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all duration-300 my-8 max-h-[90vh] overflow-y-auto">
            <div class="bg-indigo-600 px-6 py-4 rounded-t-2xl flex justify-between items-center sticky top-0 z-10">
                <h2 class="text-xl font-bold text-white flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg"
                        class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                    </svg>Nuevo Cliente</h2>
                <button onclick="closeAddClientModal()"
                    class="text-white hover:text-gray-200 transition duration-150"><svg
                        xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg></button>
            </div>
            <form id="add-client-form" onsubmit="saveClient(event)" class="p-6 space-y-5">
                <div><label for="client-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre</label><input
                        type="text" id="client-name" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm"
                        placeholder="Ej: Juan"></div>
                <div><label for="client-lastname"
                        class="block text-sm font-medium text-gray-700 mb-1">Apellidos</label><input type="text"
                        id="client-lastname" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm"
                        placeholder="Ej: P√©rez"></div>
                <div><label for="client-phone"
                        class="block text-sm font-medium text-gray-700 mb-1">Tel√©fono</label><input type="tel"
                        id="client-phone" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm"
                        placeholder="Ej: 7777-7777"></div>
                <div><label for="client-address"
                        class="block text-sm font-medium text-gray-700 mb-1">Direcci√≥n</label><textarea
                        id="client-address" rows="3" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm"
                        placeholder="Direcci√≥n completa"></textarea></div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Categor√≠as</label>
                    <div id="categories-container" class="space-y-3 bg-gray-50 p-4 rounded-xl border border-gray-200">
                    </div>
                </div>
                <div id="project-fields"
                    class="space-y-4 bg-indigo-50 p-5 rounded-xl border border-indigo-100 shadow-inner hidden">
                    <h4 class="text-xs font-bold text-indigo-800 uppercase tracking-wider mb-2">Detalles del Proyecto
                    </h4>
                    <div><label for="project-address" class="block text-sm font-medium text-gray-700 mb-1">Direcci√≥n de
                            Proyecto</label><input type="text" id="project-address"
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm bg-white"
                            placeholder="Ubicaci√≥n de la obra"></div>
                    <div><label for="project-status" class="block text-sm font-medium text-gray-700 mb-1">Estado del
                            Proyecto</label><input type="text" id="project-status"
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm bg-white"
                            placeholder="Ej: En cimentaci√≥n, Techado..."></div>
                </div>
                <div class="pt-2"><button type="submit"
                        class="w-full bg-indigo-600 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg hover:bg-indigo-700 hover:shadow-xl transform transition hover:scale-[1.02] duration-200 flex justify-center items-center gap-2"><svg
                            xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                        </svg>Guardar Cliente</button></div>
            </form>
        </div>
    </div>

    <!-- MODAL CATEGOR√çAS -->
    <div id="categories-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[100] flex items-center justify-center p-4">
        <div
            class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all duration-300 my-8 max-h-[90vh] overflow-y-auto">
            <div class="bg-purple-600 px-6 py-4 rounded-t-2xl flex justify-between items-center sticky top-0 z-10">
                <h2 class="text-xl font-bold text-white flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg"
                        class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z" />
                    </svg>Gesti√≥n de Categor√≠as</h2>
                <button onclick="closeCategoriesModal()"
                    class="text-white hover:text-gray-200 transition duration-150"><svg
                        xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg></button>
            </div>
            <div class="p-6 space-y-5">
                <div><label for="new-category-name" class="block text-sm font-medium text-gray-700 mb-1">Nueva
                        Categor√≠a</label>
                    <div class="flex gap-2"><input type="text" id="new-category-name"
                            class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition duration-150 shadow-sm"
                            placeholder="Nombre de categor√≠a"><input type="color" id="new-category-color"
                            value="#3b82f6" class="w-14 h-12 border border-gray-300 rounded-xl cursor-pointer"></div>
                </div>
                <button onclick="addCategory()"
                    class="w-full bg-purple-600 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg hover:bg-purple-700 hover:shadow-xl transform transition hover:scale-[1.02] duration-200 flex justify-center items-center gap-2"><svg
                        xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                    </svg>Agregar Categor√≠a</button>
                <hr class="border-gray-200">
                <div>
                    <h3 class="text-sm font-semibold text-gray-700 mb-3">Categor√≠as Existentes</h3>
                    <div id="categories-list" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL EDITAR CATEGOR√çA -->
    <div id="edit-category-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[110] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-sm transform transition-all duration-300">
            <div class="bg-purple-600 px-6 py-4 rounded-t-2xl flex justify-between items-center">
                <h2 class="text-xl font-bold text-white">Editar Categor√≠a</h2>
                <button onclick="closeEditCategoryModal()"
                    class="text-white hover:text-gray-200 transition duration-150"><svg
                        xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg></button>
            </div>
            <div class="p-6 space-y-4">
                <input type="hidden" id="edit-category-old-name">
                <div><label for="edit-category-name"
                        class="block text-sm font-medium text-gray-700 mb-1">Nombre</label><input type="text"
                        id="edit-category-name"
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition duration-150 shadow-sm">
                </div>
                <div><label for="edit-category-color"
                        class="block text-sm font-medium text-gray-700 mb-1">Color</label><input type="color"
                        id="edit-category-color" class="w-full h-12 border border-gray-300 rounded-xl cursor-pointer">
                </div>
                <button onclick="updateCategory()"
                    class="w-full bg-purple-600 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg hover:bg-purple-700 hover:shadow-xl transform transition hover:scale-[1.02] duration-200">Actualizar</button>
            </div>
        </div>
    </div>

    <!-- MODAL DETALLES CLIENTE -->
    <div id="client-detail-modal"
        class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[100] flex items-center justify-center p-4">
        <div
            class="bg-white rounded-2xl shadow-2xl w-full max-w-md transform transition-all duration-300 my-8 max-h-[90vh] overflow-y-auto">
            <div class="bg-indigo-600 px-6 py-4 rounded-t-2xl flex justify-between items-center sticky top-0 z-10">
                <h2 class="text-xl font-bold text-white flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg"
                        class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>Detalles del Cliente</h2>
                <button onclick="closeClientDetailModal()"
                    class="text-white hover:text-gray-200 transition duration-150"><svg
                        xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M6 18L18 6M6 6l12 12" />
                    </svg></button>
            </div>
            <form id="edit-client-form" onsubmit="updateClient(event)" class="p-6 space-y-5">
                <input type="hidden" id="edit-client-id">
                <div><label for="edit-client-name"
                        class="block text-sm font-medium text-gray-700 mb-1">Nombre</label><input type="text"
                        id="edit-client-name" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm">
                </div>
                <div><label for="edit-client-lastname"
                        class="block text-sm font-medium text-gray-700 mb-1">Apellidos</label><input type="text"
                        id="edit-client-lastname" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm">
                </div>
                <div><label for="edit-client-phone"
                        class="block text-sm font-medium text-gray-700 mb-1">Tel√©fono</label><input type="tel"
                        id="edit-client-phone" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm">
                </div>
                <div><label for="edit-client-address"
                        class="block text-sm font-medium text-gray-700 mb-1">Direcci√≥n</label><textarea
                        id="edit-client-address" rows="3" required
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm"></textarea>
                </div>
                <div><label class="block text-sm font-medium text-gray-700 mb-2">Categor√≠as</label>
                    <div id="edit-categories-container"
                        class="space-y-3 bg-gray-50 p-4 rounded-xl border border-gray-200"></div>
                </div>
                <div id="edit-project-fields"
                    class="space-y-4 bg-indigo-50 p-5 rounded-xl border border-indigo-100 shadow-inner hidden">
                    <h4 class="text-xs font-bold text-indigo-800 uppercase tracking-wider mb-2">Detalles del Proyecto
                    </h4>
                    <div><label for="edit-project-address"
                            class="block text-sm font-medium text-gray-700 mb-1">Direcci√≥n de Proyecto</label><input
                            type="text" id="edit-project-address"
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm bg-white">
                    </div>
                    <div><label for="edit-project-status" class="block text-sm font-medium text-gray-700 mb-1">Estado
                            del Proyecto</label><input type="text" id="edit-project-status"
                            class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150 shadow-sm bg-white">
                    </div>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="submit"
                        class="flex-1 bg-indigo-600 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg hover:bg-indigo-700 hover:shadow-xl transform transition hover:scale-[1.02] duration-200 flex justify-center items-center gap-2"><svg
                            xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>Actualizar</button>
                    <button type="button" onclick="deleteClient()"
                        class="bg-red-500 text-white font-bold py-3.5 px-4 rounded-xl shadow-lg hover:bg-red-600 hover:shadow-xl transform transition hover:scale-[1.02] duration-200 flex justify-center items-center"><svg
                            xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg></button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL DE PORTABILIDAD -->

    <div id="chargeModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/50">
        <div class="bg-white w-full max-w-md mx-4 rounded-2xl shadow-xl p-6 space-y-4">

            <h2 class="text-xl font-bold text-gray-800">Portabilidad de Contactos</h2>
            <p class="text-sm text-gray-600">
                Descarga o importa contactos. Las categor√≠as nuevas se crear√°n autom√°ticamente.
            </p>

            <button onclick="exportContactsToCsv()"
                class="w-full p-3 rounded-lg bg-green-600 text-white font-semibold hover:bg-green-700 transition">
                Descargar contactos (CSV)
            </button>

            <input type="file" id="csvFileInput" accept=".csv" class="hidden" onchange="importContactsFromCsv(event)">

            <button onclick="document.getElementById('csvFileInput').click()"
                class="w-full p-3 rounded-lg bg-blue-600 text-white font-semibold hover:bg-blue-700 transition">
                Cargar y fusionar CSV
            </button>

            <button onclick="closeChargeModal()"
                class="w-full p-2 border rounded-lg text-gray-600 hover:bg-gray-100 transition">
                Cancelar
            </button>

        </div>
    </div>


    <div id="message-box" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 z-[100] items-center justify-center">
        <div
            class="bg-white rounded-xl shadow-2xl p-6 max-w-sm mx-auto text-center transform transition-all duration-300">
            <p id="message-text" class="text-gray-700 font-semibold mb-4 whitespace-pre-line text-left"></p>
            <button id="close-message-btn"
                class="px-4 py-2 bg-indigo-500 text-white rounded-full hover:bg-indigo-600 transition duration-150">Entendido</button>
        </div>
    </div>

    <script>
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let db, auth, userId = 'guest';
        let allClients = [];
        let currentClientId = null;
        let categories = [];

        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const closeMessageBtn = document.getElementById('close-message-btn');
        const addClientModal = document.getElementById('add-client-modal');
        const addClientForm = document.getElementById('add-client-form');
        const projectFields = document.getElementById('project-fields');
        const clientDetailModal = document.getElementById('client-detail-modal');
        const clientSearch = document.getElementById('client-search');
        const clientsList = document.getElementById('clients-list');
        const noClientsMessage = document.getElementById('no-clients-message');
        const categoriesModal = document.getElementById('categories-modal');
        const editCategoryModal = document.getElementById('edit-category-modal');

        function initializeCategories() {
            const storedCategories = localStorage.getItem('categories');
            if (!storedCategories) {
                categories = [{ name: 'Proyectos', color: '#3b82f6', protected: true }];
                localStorage.setItem('categories', JSON.stringify(categories));
            } else {
                categories = JSON.parse(storedCategories);
            }
        }

        function getCategoryStyle(categoryName) {
            const cat = categories.find(c => c.name === categoryName);
            if (!cat) return 'background-color: #e5e7eb; color: #374151;';
            return `background-color: ${cat.color}20; color: ${cat.color}; border: 1px solid ${cat.color}40;`;
        }

        async function initializeAppAndAuth() {
            const isLocalEnvironment = Object.keys(firebaseConfig).length === 0;
            if (isLocalEnvironment) {
                console.warn("Ejecutando en entorno local (sin config de Firebase). Omitiendo Auth.");
                userId = 'local-dev';
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                onAuthStateChanged(auth, (user) => {
                    userId = user ? user.uid : 'anonymous';
                });
            } catch (error) {
                console.error("Error al inicializar Firebase o autenticar:", error);
                showMessage('Error cr√≠tico de autenticaci√≥n. Ver consola.');
            }
        }

        function showMessage(message) {
            messageText.textContent = message;
            messageBox.classList.remove('hidden');
            messageBox.classList.add('flex');
        }

        function hideMessage() {
            messageBox.classList.add('hidden');
            messageBox.classList.remove('flex');
        }

        async function handleLogout() {
            if (userId === 'local-dev') {
                showMessage("Est√°s en modo de desarrollo local. No hay una sesi√≥n de Firebase activa para cerrar.");
                return;
            }
            try {
                if (auth) {
                    await signOut(auth);
                    showMessage("Sesi√≥n cerrada. Los datos sensibles est√°n protegidos.");
                    setTimeout(() => window.location.href = 'index.html', 1500);
                } else {
                    showMessage("Error de autenticaci√≥n: El servicio no est√° inicializado.");
                }
            } catch (error) {
                showMessage(`Error al cerrar sesi√≥n: ${error.message}`);
                console.error("Logout Error:", error);
            }
        }

        function openCategoriesModal() {
            categoriesModal.classList.remove('hidden');
            categoriesModal.classList.add('flex');
            renderCategoriesList();
        }

        function closeCategoriesModal() {
            categoriesModal.classList.add('hidden');
            categoriesModal.classList.remove('flex');
        }

        function renderCategoriesList() {
            const list = document.getElementById('categories-list');
            list.innerHTML = '';
            categories.forEach(cat => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200';
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-6 h-6 rounded-full border-2" style="background-color: ${cat.color};"></div>
                        <span class="font-medium text-gray-900">${cat.name}</span>
                        ${cat.protected ? '<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full">Protegida</span>' : ''}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openEditCategory('${cat.name}')" class="p-2 text-purple-600 hover:bg-purple-50 rounded-lg transition">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                        </button>
                        ${!cat.protected ? `<button onclick="deleteCategory('${cat.name}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></button>` : ''}
                    </div>
                `;
                list.appendChild(item);
            });
        }

        function addCategory() {
            const name = document.getElementById('new-category-name').value.trim();
            const color = document.getElementById('new-category-color').value;
            if (!name) {
                showMessage('Por favor ingresa un nombre para la categor√≠a.');
                return;
            }
            if (categories.find(c => c.name.toLowerCase() === name.toLowerCase())) {
                showMessage('Ya existe una categor√≠a con ese nombre.');
                return;
            }
            categories.push({ name, color, protected: false });
            localStorage.setItem('categories', JSON.stringify(categories));
            document.getElementById('new-category-name').value = '';
            renderCategoriesList();
            updateCategoriesInModals();
            showMessage('Categor√≠a agregada correctamente.');
        }

        function openEditCategory(categoryName) {
            const cat = categories.find(c => c.name === categoryName);
            if (!cat) return;
            document.getElementById('edit-category-old-name').value = categoryName;
            document.getElementById('edit-category-name').value = categoryName;
            document.getElementById('edit-category-color').value = cat.color;
            if (cat.protected) {
                document.getElementById('edit-category-name').disabled = true;
            } else {
                document.getElementById('edit-category-name').disabled = false;
            }
            editCategoryModal.classList.remove('hidden');
            editCategoryModal.classList.add('flex');
        }

        function closeEditCategoryModal() {
            editCategoryModal.classList.add('hidden');
            editCategoryModal.classList.remove('flex');
        }

        function updateCategory() {
            const oldName = document.getElementById('edit-category-old-name').value;
            const newName = document.getElementById('edit-category-name').value.trim();
            const newColor = document.getElementById('edit-category-color').value;

            const cat = categories.find(c => c.name === oldName);
            if (!cat) return;

            if (cat.protected && newName !== oldName) {
                showMessage('No puedes cambiar el nombre de una categor√≠a protegida.');
                return;
            }

            if (newName !== oldName && categories.find(c => c.name.toLowerCase() === newName.toLowerCase())) {
                showMessage('Ya existe una categor√≠a con ese nombre.');
                return;
            }

            cat.name = newName;
            cat.color = newColor;
            localStorage.setItem('categories', JSON.stringify(categories));

            if (oldName !== newName) {
                const clients = JSON.parse(localStorage.getItem('clients') || '[]');
                clients.forEach(client => {
                    if (client.categories && client.categories.includes(oldName)) {
                        client.categories = client.categories.map(c => c === oldName ? newName : c);
                    }
                });
                localStorage.setItem('clients', JSON.stringify(clients));
            }

            closeEditCategoryModal();
            renderCategoriesList();
            updateCategoriesInModals();
            loadAndDisplayClients();
            showMessage('Categor√≠a actualizada correctamente.');
        }

        function deleteCategory(categoryName) {
            if (!confirm(`¬øEst√°s seguro de que deseas eliminar la categor√≠a "${categoryName}"?`)) return;
            categories = categories.filter(c => c.name !== categoryName);
            localStorage.setItem('categories', JSON.stringify(categories));

            const clients = JSON.parse(localStorage.getItem('clients') || '[]');
            clients.forEach(client => {
                if (client.categories) {
                    client.categories = client.categories.filter(c => c !== categoryName);
                }
            });
            localStorage.setItem('clients', JSON.stringify(clients));

            renderCategoriesList();
            updateCategoriesInModals();
            loadAndDisplayClients();
            showMessage('Categor√≠a eliminada correctamente.');
        }

        function updateCategoriesInModals() {
            const container = document.getElementById('categories-container');
            container.innerHTML = '';
            categories.forEach(cat => {
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-3 cursor-pointer group';
                label.innerHTML = `
                    <input type="checkbox" value="${cat.name}" class="category-checkbox w-5 h-5 border-gray-300 rounded focus:ring-2 cursor-pointer" onchange="toggleProjectFields()" style="accent-color: ${cat.color};">
                    <span class="text-sm font-medium text-gray-700 group-hover:opacity-75 transition duration-150">${cat.name}</span>
                `;
                container.appendChild(label);
            });
        }

        function openAddClientModal() {
            addClientModal.classList.remove('hidden');
            addClientModal.classList.add('flex');
            addClientForm.reset();
            updateCategoriesInModals();
            const proyectosCheckbox = document.querySelector('.category-checkbox[value="Proyectos"]');
            if (proyectosCheckbox) proyectosCheckbox.checked = true;
            toggleProjectFields();
        }

        function closeAddClientModal() {
            addClientModal.classList.add('hidden');
            addClientModal.classList.remove('flex');
        }

        function toggleProjectFields() {
            const proyectosCheckbox = document.querySelector('.category-checkbox[value="Proyectos"]');
            if (proyectosCheckbox && proyectosCheckbox.checked) {
                projectFields.classList.remove('hidden');
            } else {
                projectFields.classList.add('hidden');
            }
        }

        function saveClient(event) {
            event.preventDefault();
            const selectedCategories = Array.from(document.querySelectorAll('.category-checkbox:checked')).map(cb => cb.value);
            const clientData = {
                id: Date.now().toString(),
                name: document.getElementById('client-name').value.trim(),
                lastname: document.getElementById('client-lastname').value.trim(),
                phone: document.getElementById('client-phone').value.trim(),
                address: document.getElementById('client-address').value.trim(),
                categories: selectedCategories,
                createdAt: new Date().toISOString()
            };
            if (selectedCategories.includes('Proyectos')) {
                clientData.projectAddress = document.getElementById('project-address').value.trim();
                clientData.projectStatus = document.getElementById('project-status').value.trim();
            }
            try {
                const existingClients = JSON.parse(localStorage.getItem('clients') || '[]');
                const duplicateClient = existingClients.find(client => client.phone === clientData.phone);
                if (duplicateClient) {
                    const categoriesText = duplicateClient.categories ? duplicateClient.categories.join(', ') : 'Sin categor√≠as';
                    let message = `‚ö†Ô∏è Ya existe un cliente con el n√∫mero ${duplicateClient.phone}: \n\n`;
                    message += `üìã Nombre: ${duplicateClient.name} ${duplicateClient.lastname} \n`;
                    message += `üìç Direcci√≥n: ${duplicateClient.address} \n`;
                    message += `üè∑Ô∏è Categor√≠as: ${categoriesText} \n`;
                    if (duplicateClient.projectAddress) message += `üèóÔ∏è Proyecto: ${duplicateClient.projectAddress} \n`;
                    if (duplicateClient.projectStatus) message += `üìä Estado: ${duplicateClient.projectStatus} \n`;
                    message += `\n‚ùå No se puede guardar un cliente con el mismo n√∫mero.`;
                    showMessage(message);
                    return;
                }
                existingClients.push(clientData);
                localStorage.setItem('clients', JSON.stringify(existingClients));
                showMessage(`Cliente ${clientData.name} guardado correctamente.`);
                closeAddClientModal();
                loadAndDisplayClients();
            } catch (error) {
                console.error("Error al guardar en LocalStorage:", error);
                showMessage("Error al guardar el cliente. Verifique el almacenamiento.");
            }
        }

        function loadAndDisplayClients(searchTerm = '') {
            try {
                allClients = JSON.parse(localStorage.getItem('clients') || '[]');
                let filteredClients = allClients;

                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    filteredClients = allClients.filter(client => {
                        const fullName = `${client.name} ${client.lastname}`.toLowerCase();
                        const categories = (client.categories || []).join(' ').toLowerCase();
                        return fullName.includes(term) ||
                            client.phone.includes(term) ||
                            client.address.toLowerCase().includes(term) ||
                            categories.includes(term);
                    });
                }

                clientsList.innerHTML = '';
                if (filteredClients.length === 0) {
                    noClientsMessage.classList.remove('hidden');
                    return;
                }

                noClientsMessage.classList.add('hidden');

                filteredClients.forEach(client => {
                    const clientCard = document.createElement('div');
                    clientCard.className =
                        'bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow duration-200 px-4 py-3 flex items-center justify-between cursor-pointer border border-gray-100';
                    clientCard.onclick = () => openClientDetail(client.id);

                    const leftSection = document.createElement('div');
                    leftSection.className = 'flex-1 flex items-center gap-3';

                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'font-semibold text-gray-900';
                    nameDiv.textContent = `${client.name} ${client.lastname}`;
                    leftSection.appendChild(nameDiv);

                    if (client.categories && client.categories.length > 0) {
                        const categoriesDiv = document.createElement('div');
                        categoriesDiv.className = 'flex gap-1';
                        client.categories.forEach(catName => {
                            const badge = document.createElement('span');
                            badge.className = 'px-2 py-0.5 rounded-full text-xs font-medium';
                            badge.style.cssText = getCategoryStyle(catName);
                            badge.textContent = catName;
                            categoriesDiv.appendChild(badge);
                        });
                        leftSection.appendChild(categoriesDiv);
                    }

                    const whatsappBtn = document.createElement('button');
                    whatsappBtn.className =
                        'p-2 bg-green-500 text-white rounded-full hover:bg-green-600 transition-colors duration-200 flex-shrink-0';

                    whatsappBtn.onclick = (e) => {
                        e.stopPropagation();

                        const phoneNumber = client.phone.replace(/[^0-9]/g, '');

                        // üîπ Obtener plantilla
                        let template = localStorage.getItem('messageTemplate') || '';

                        // üîπ Reemplazar variables
                        let personalizedMessage = template
                            .replaceAll('{{Nombre}}', client.name || '')
                            .replaceAll('{{Apellido}}', client.lastname || '')
                            .replaceAll('{{Direcci√≥n}}', client.address || '');

                        // üîπ Codificar para URL
                        const encodedMessage = encodeURIComponent(personalizedMessage);

                        // üîπ Abrir WhatsApp
                        window.open(
                            `https://wa.me/${phoneNumber}?text=${encodedMessage}`,
                            '_blank'
                        );
                    };

                    whatsappBtn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L0 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/></svg>';

                    clientCard.appendChild(leftSection);
                    clientCard.appendChild(whatsappBtn);
                    clientsList.appendChild(clientCard);
                });

            } catch (error) {
                console.error("Error al cargar clientes:", error);
            }
        }


        function openClientDetail(clientId) {
            const client = allClients.find(c => c.id === clientId);
            if (!client) return;

            currentClientId = clientId;

            if (!document.getElementById('clientViewModal')) {
                const modalHTML = `
<div id="clientViewModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm">
    <div class="bg-white w-full max-w-lg mx-4 rounded-2xl shadow-2xl overflow-hidden">

        <!-- Header -->
        <div class="px-6 py-4 border-b">
            <h2 class="text-xl font-bold text-gray-800">Detalle del Cliente</h2>
        </div>

        <!-- Contenido -->
        <div class="p-6 space-y-6 text-sm text-gray-700">

            <!-- Informaci√≥n principal -->
            <div class="space-y-2">
                <p>
                    <span class="font-semibold text-gray-600">Nombre:</span>
                    <span id="view-name" class="ml-1"></span>
                </p>
                <p>
                    <span class="font-semibold text-gray-600">Tel√©fono:</span>
                    <span id="view-phone" class="ml-1"></span>
                </p>
                <p>
                    <span class="font-semibold text-gray-600">Direcci√≥n:</span>
                    <span id="view-address" class="ml-1"></span>
                </p>
                <p>
                    <span class="font-semibold text-gray-600">Categor√≠as:</span>
                    <span id="view-categories" class="ml-1"></span>
                </p>
            </div>

            <!-- Informaci√≥n del Proyecto -->
            <div id="view-project-info" class="hidden rounded-xl bg-sky-900 text-sky-100 p-4 space-y-2 shadow-inner">
                <h3 class="text-sm font-semibold uppercase tracking-wide text-sky-200">
                    Informaci√≥n del Proyecto
                </h3>

                <p>
                    <span class="font-medium text-sky-300">Direcci√≥n:</span>
                    <span id="view-project-address" class="ml-1"></span>
                </p>
                <p>
                    <span class="font-medium text-sky-300">Estado:</span>
                    <span id="view-project-status" class="ml-1"></span>
                </p>
            </div>

        </div>

        <!-- Footer / Acciones -->
        <div class="flex justify-end gap-2 px-6 py-4 border-t bg-gray-50">
            <button
                onclick="openEditClientModal()"
                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                Editar
            </button>

            <button
                onclick="deleteClient()"
                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                Eliminar
            </button>

            <button
                onclick="closeClientViewModal()"
                class="px-4 py-2 border rounded-lg hover:bg-gray-100 transition">
                Cerrar
            </button>
        </div>

    </div>
</div>

        `;
                document.body.insertAdjacentHTML('beforeend', modalHTML);
            }

            document.getElementById('view-name').textContent = `${client.name} ${client.lastname}`;
            document.getElementById('view-phone').textContent = client.phone;
            document.getElementById('view-address').textContent = client.address;
            document.getElementById('view-categories').textContent = (client.categories || []).join(', ');

            if (client.categories && client.categories.includes('Proyectos')) {
                document.getElementById('view-project-info').classList.remove('hidden');
                document.getElementById('view-project-address').textContent = client.projectAddress || '';
                document.getElementById('view-project-status').textContent = client.projectStatus || '';
            } else {
                document.getElementById('view-project-info').classList.add('hidden');
            }

            const modal = document.getElementById('clientViewModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeClientViewModal() {
            const modal = document.getElementById('clientViewModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function openEditClientModal() {
            closeClientViewModal();

            const client = allClients.find(c => c.id === currentClientId);
            if (!client) return;

            document.getElementById('edit-client-id').value = client.id;
            document.getElementById('edit-client-name').value = client.name;
            document.getElementById('edit-client-lastname').value = client.lastname;
            document.getElementById('edit-client-phone').value = client.phone;
            document.getElementById('edit-client-address').value = client.address;

            const editCategoriesContainer = document.getElementById('edit-categories-container');
            editCategoriesContainer.innerHTML = '';

            categories.forEach(cat => {
                const isChecked = client.categories && client.categories.includes(cat.name);
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-3 cursor-pointer group';
                label.innerHTML = `
            <input type="checkbox" value="${cat.name}"
                class="edit-category-checkbox w-5 h-5 border-gray-300 rounded"
                ${isChecked ? 'checked' : ''}>
            <span class="text-sm font-medium">${cat.name}</span>
        `;
                editCategoriesContainer.appendChild(label);
            });

            document.getElementById('edit-project-address').value = client.projectAddress || '';
            document.getElementById('edit-project-status').value = client.projectStatus || '';

            toggleEditProjectFields();

            clientDetailModal.classList.remove('hidden');
            clientDetailModal.classList.add('flex');
        }

        function toggleEditProjectFields() {
            const proyectosCheckbox = document.querySelector('.edit-category-checkbox[value="Proyectos"]');
            const editProjectFields = document.getElementById('edit-project-fields');
            if (proyectosCheckbox && proyectosCheckbox.checked) {
                editProjectFields.classList.remove('hidden');
            } else {
                editProjectFields.classList.add('hidden');
            }
        }

        function updateClient(event) {
            event.preventDefault();

            const clientId = document.getElementById('edit-client-id').value;
            const selectedCategories = Array.from(
                document.querySelectorAll('.edit-category-checkbox:checked')
            ).map(cb => cb.value);

            const updatedClient = {
                id: clientId,
                name: document.getElementById('edit-client-name').value.trim(),
                lastname: document.getElementById('edit-client-lastname').value.trim(),
                phone: document.getElementById('edit-client-phone').value.trim(),
                address: document.getElementById('edit-client-address').value.trim(),
                categories: selectedCategories,
                updatedAt: new Date().toISOString()
            };

            if (selectedCategories.includes('Proyectos')) {
                updatedClient.projectAddress = document.getElementById('edit-project-address').value.trim();
                updatedClient.projectStatus = document.getElementById('edit-project-status').value.trim();
            }

            try {
                const clients = JSON.parse(localStorage.getItem('clients') || '[]');
                const index = clients.findIndex(c => c.id === clientId);
                if (index !== -1) {
                    updatedClient.createdAt = clients[index].createdAt;
                    clients[index] = updatedClient;
                    localStorage.setItem('clients', JSON.stringify(clients));
                    showMessage('Cliente actualizado correctamente.');
                    clientDetailModal.classList.add('hidden');
                    clientDetailModal.classList.remove('flex');
                    loadAndDisplayClients();
                }
            } catch (error) {
                console.error("Error al actualizar cliente:", error);
                showMessage("Error al actualizar el cliente.");
            }
        }

        function deleteClient() {
            if (!currentClientId) return;
            if (!confirm('¬øEst√°s seguro de que deseas eliminar este cliente?')) return;

            try {
                const clients = JSON.parse(localStorage.getItem('clients') || '[]');
                const filteredClients = clients.filter(c => c.id !== currentClientId);
                localStorage.setItem('clients', JSON.stringify(filteredClients));
                showMessage('Cliente eliminado correctamente.');
                closeClientViewModal();
                loadAndDisplayClients();
            } catch (error) {
                console.error("Error al eliminar cliente:", error);
                showMessage("Error al eliminar el cliente.");
            }
        }
        function closeClientDetailModal() { clientDetailModal.classList.add('hidden'); clientDetailModal.classList.remove('flex'); currentClientId = null; }


        //FUNCION PARA EL MODAL DE CARGAR CSV O DESCARGAR//

        function openChargeModal() {
            document.getElementById('chargeModal').classList.remove('hidden');
            document.getElementById('chargeModal').classList.add('flex');
        }

        function closeChargeModal() {
            document.getElementById('chargeModal').classList.add('hidden');
            document.getElementById('chargeModal').classList.remove('flex');
        }

        /* ===============================
           EXPORTAR CSV
        ================================ */
        function exportContactsToCsv() {
            const clients = JSON.parse(localStorage.getItem('clients') || '[]');

            if (!clients.length) {
                alert('No hay contactos para exportar.');
                return;
            }

            const headers = [
                'id', 'name', 'lastname', 'phone', 'address',
                'categories', 'projectAddress', 'projectStatus',
                'createdAt', 'updatedAt'
            ];

            const rows = clients.map(c => [
                c.id || '',
                c.name || '',
                c.lastname || '',
                c.phone || '',
                c.address || '',
                (c.categories || []).join('|'),
                c.projectAddress || '',
                c.projectStatus || '',
                c.createdAt || '',
                c.updatedAt || ''
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(r => {
                csv += r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'clientes.csv';
            link.click();

            closeChargeModal();
        }

        /* ===============================
           IMPORTAR CSV
        ================================ */
        function importContactsFromCsv(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = e => processCsv(e.target.result);
            reader.readAsText(file);

            event.target.value = '';
        }


        function processCsv(csvText) {
            const lines = csvText.split('\n').filter(l => l.trim());
            const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());

            let clients = JSON.parse(localStorage.getItem('clients') || '[]');
            let categories = JSON.parse(localStorage.getItem('categories') || '[]');

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                if (!values) continue;

                const row = {};
                headers.forEach((h, idx) => {
                    row[h] = values[idx]?.replace(/^"|"$|""/g, '') || '';
                });

                const importedCategories = row.categories
                    ? row.categories.split('|').map(c => c.trim()).filter(Boolean)
                    : [];

                importedCategories.forEach(cat => {
                    if (!categories.find(c => c.name === cat)) {
                        categories.push({
                            name: cat,
                            color: '#3b82f6',
                            createdAt: new Date().toISOString()
                        });
                    }
                });

                const existingIndex = clients.findIndex(c =>
                    c.phone === row.phone && row.phone
                );

                const clientData = {
                    id: row.id || crypto.randomUUID(),
                    name: row.name,
                    lastname: row.lastname,
                    phone: row.phone,
                    address: row.address,
                    categories: importedCategories,
                    projectAddress: row.projectAddress || '',
                    projectStatus: row.projectStatus || '',
                    createdAt: row.createdAt || new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                if (existingIndex !== -1) {
                    clientData.createdAt = clients[existingIndex].createdAt;
                    clients[existingIndex] = clientData;
                } else {
                    clients.push(clientData);
                }
            }

            localStorage.setItem('clients', JSON.stringify(clients));
            localStorage.setItem('categories', JSON.stringify(categories));

            closeChargeModal();
            loadAndDisplayClients();
            alert('CSV importado correctamente.');
        }


        document.addEventListener('DOMContentLoaded', () => {
            initializeCategories();
            initializeAppAndAuth();
            loadAndDisplayClients();
            closeMessageBtn.addEventListener('click', hideMessage);
            clientSearch.addEventListener('input', (e) => loadAndDisplayClients(e.target.value));

            addClientModal.addEventListener('click', (e) => {
                if (e.target.id === 'add-client-modal') closeAddClientModal();
            });

            clientDetailModal.addEventListener('click', (e) => {
                if (e.target.id === 'client-detail-modal') closeClientDetailModal();
            });

            categoriesModal.addEventListener('click', (e) => {
                if (e.target.id === 'categories-modal') closeCategoriesModal();
            });

            editCategoryModal.addEventListener('click', (e) => {
                if (e.target.id === 'edit-category-modal') closeEditCategoryModal();
            });

            const menuToggle = document.getElementById('menu-toggle');
            const mobileMenu = document.getElementById('mobile-menu');
            const iconMenu = document.getElementById('icon-menu');
            const iconClose = document.getElementById('icon-close');

            menuToggle.addEventListener('click', () => {
                const isExpanded = menuToggle.getAttribute('aria-expanded') === 'true' || false;
                menuToggle.setAttribute('aria-expanded', !isExpanded);
                mobileMenu.classList.toggle('hidden');
                iconMenu.classList.toggle('hidden');
                iconClose.classList.toggle('hidden');
                document.body.classList.toggle('no-scroll', !isExpanded);
            });

            document.querySelectorAll('#mobile-menu a').forEach(link => {
                link.addEventListener('click', () => {
                    if (!mobileMenu.classList.contains('hidden')) menuToggle.click();
                });
            });

            document.getElementById('logout-button-desktop').addEventListener('click', handleLogout);
            document.getElementById('logout-button-mobile').addEventListener('click', handleLogout);
        });
        function openSendModal() {

            // ====== MODAL DE REDACTAR MENSAJE ======
            if (!document.getElementById('sendModal')) {
                const modalHTML = `
        <div id="sendModal"
             class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">

            <div class="bg-white w-full max-w-lg mx-4 rounded-2xl shadow-2xl
                        flex flex-col max-h-[90vh] animate-scaleIn">

                <!-- Header -->
                <div class="flex justify-between items-center p-4 border-b">
                    <h3 class="text-lg font-bold">Plantilla de Mensaje</h3>
                    <button id="closeModalBtn" class="text-2xl">&times;</button>
                </div>

                <!-- Body -->
                <div class="p-4 space-y-3 overflow-y-auto">

                    <div class="flex flex-wrap gap-2">
                        <span draggable="true" data-text="{{Nombre}}"
                            class="bg-blue-100 text-blue-800 text-xs px-3 py-1 rounded-full cursor-grab">
                            Nombre
                        </span>
                        <span draggable="true" data-text="{{Apellido}}"
                            class="bg-blue-100 text-blue-800 text-xs px-3 py-1 rounded-full cursor-grab">
                            Apellido
                        </span>
                        <span draggable="true" data-text="{{Direcci√≥n}}"
                            class="bg-blue-100 text-blue-800 text-xs px-3 py-1 rounded-full cursor-grab">
                            Direcci√≥n
                        </span>
                    </div>

                    <textarea id="modalMessageTemplate"
                        rows="12"
                        placeholder="Hola {{Nombre}}, te escribo para..."
                        class="w-full p-3 border rounded-lg focus:ring-2 ring-purple-500">
                    </textarea>

                </div>

                <!-- Footer -->
                <div class="p-4 border-t flex justify-end gap-2">
                    <button id="cancelBtn"
                        class="px-4 py-2 border rounded-lg">Cancelar</button>
                    <button id="saveBtn"
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg">
                        Guardar
                    </button>
                </div>
            </div>
        </div>
        `;

                document.body.insertAdjacentHTML('beforeend', modalHTML);

                // ====== ANIMACI√ìN ======
                if (!document.getElementById('modalAnimStyle')) {
                    const style = document.createElement('style');
                    style.id = 'modalAnimStyle';
                    style.innerHTML = `
                @keyframes scaleIn {
                    from { transform: scale(.95); opacity: 0; }
                    to { transform: scale(1); opacity: 1; }
                }
                .animate-scaleIn {
                    animation: scaleIn .2s ease-out;
                }
            `;
                    document.head.appendChild(style);
                }

                // ====== EVENTOS ======
                const modal = document.getElementById('sendModal');
                const textarea = document.getElementById('modalMessageTemplate');

                document.getElementById('closeModalBtn').onclick =
                    document.getElementById('cancelBtn').onclick = () => {
                        modal.remove();
                    };

                document.getElementById('saveBtn').onclick = () => {
                    localStorage.setItem('messageTemplate', textarea.value);
                    modal.remove();
                };

                // Drag & Drop
                document.querySelectorAll('[draggable=true]').forEach(el => {
                    el.addEventListener('dragstart', e => {
                        e.dataTransfer.setData('text/plain', el.dataset.text);
                    });
                });

                textarea.addEventListener('dragover', e => e.preventDefault());
                textarea.addEventListener('drop', e => {
                    e.preventDefault();
                    const text = e.dataTransfer.getData('text/plain');
                    const start = textarea.selectionStart;
                    textarea.value =
                        textarea.value.slice(0, start) +
                        text +
                        textarea.value.slice(start);
                });
            }

            // ====== CARGAR PLANTILLA ======
            const textarea = document.getElementById('modalMessageTemplate');
            textarea.value = localStorage.getItem('messageTemplate') || '';
            textarea.focus();
        }
    </script>
</body>

</html>
