<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <title>Cat√°logo de Precios - Galvanissa</title>

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- PapaParse -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Leaflet CSS y JS desde unpkg.com (sin integrity para evitar bloqueos) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Fuente Inter y estilos personalizados -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }

        .color-galvanissa {
            color: #293241;
        }

        .sort-icon {
            display: inline-block;
            margin-left: 0.5rem;
            color: #3b82f6;
        }

        #product-table {
            display: none;
        }
        /* üö´ Bloquear gestos de zoom SOLO cuando el modal est√° abierto */
.modal-open {
    touch-action: none;
    overscroll-behavior: contain;
}


        @media (min-width: 768px) {
            #mobileList {
                display: none;
            }

            #product-table {
                display: table;
            }
        }

        .no-scroll {
            overflow: hidden;
        }

        /* Estilo del contenedor del mapa */
        #map {
            height: 100vh;
            width: 100%;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        /* üö´ Bloquear gestos de zoom SOLO cuando el modal est√° abierto */
.modal-open {
    touch-action: none;
    overscroll-behavior: contain;
}


        @media (max-width: 767px) {
            #map {
                height: 100vh;
                z-index: 0;
            }
            /* üö´ Bloquear gestos de zoom SOLO cuando el modal est√° abierto */
.modal-open {
    touch-action: none;
    overscroll-behavior: contain;
}

        }

        /* FAB */
        .fab-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 40;
        }

        .fab-button {
            background-color: #293241;
            color: white;
            width: 3.5rem;
            height: 3.5rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .fab-button:hover {
            transform: scale(1.1);
            background-color: #3d5a80;
        }

        .fab-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 1.5rem;
            height: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            border: 2px solid white;
        }
    </style>

    <link rel="manifest" href="manifest.json">
</head>

<body class="antialiased">
    <!-- A√±adimos un ancla invisible en la parte superior -->
    <a id="top"></a>

    <!-- Contenido Principal -->
    <div id="main-content">
        <!-- Navbar Responsivo -->
        <header class="bg-white shadow-md sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <!-- Logo -->
                    <a href="#top"
                        class="flex-shrink-0 text-xl font-extrabold tracking-tight transition duration-150 ease-in-out hover:text-indigo-800"
                        style="color: #293241;"
                        onclick="event.preventDefault(); window.scrollTo({ top: 0, behavior: 'smooth' });">
                        Adonay Tobar
                    </a>

                    <!-- Navegaci√≥n (Desktop/Tablet) -->
                    <nav id="main-nav" class="hidden md:flex space-x-6 items-center">
                        <a href="index.html"
                            class="text-indigo-600 font-bold transition duration-150 ease-in-out">Precios</a>
                        <a href="clientes.html"
                            class="text-gray-600 hover:text-indigo-600 font-medium transition duration-150 ease-in-out">Clientes</a>
                        <a href="proyectos.html"
                            class="text-gray-600 hover:text-indigo-600 font-medium transition duration-150 ease-in-out">Proyectos</a>
                    </nav>

                    <!-- Men√∫ Hamburguesa (M√≥vil) -->
                    <div class="md:hidden flex items-center">
                        <button id="menu-toggle"
                            class="inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500 transition duration-150 ease-in-out"
                            aria-expanded="false">
                            <svg class="block h-6 w-6" id="icon-menu" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                            <svg class="hidden h-6 w-6" id="icon-close" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Men√∫ M√≥vil Desplegable -->
            <div id="mobile-menu" class="hidden md:hidden absolute w-full bg-white shadow-xl">
                <div class="pt-2 pb-3 space-y-1 px-4 border-t border-gray-100">
                    <a href="index.html"
                        class="block rounded-lg py-2 px-3 text-base font-bold text-indigo-600 bg-indigo-50">Precios</a>
                    <a href="clientes.html"
                        class="block rounded-lg py-2 px-3 text-base font-medium text-gray-700 hover:bg-indigo-50 hover:text-indigo-600">Clientes</a>
                    <a href="proyectos.html"
                        class="block rounded-lg py-2 px-3 text-base font-bold text-indigo-600 bg-indigo-50">Proyectos</a>
                </div>
            </div>
        </header>

        <!-- ==================== MAPA DE OPENSTREETMAP ==================== -->
        <div class="w-full mx-auto sm:px-6 lg:px-8">
            <div id="map" class="w-full h-screen"></div>
        </div>
        <!-- ============================================================= -->

    </div>

    <div class="fab-container">
        <button id="openModalBtn" class="fab-button" title="Agregar punto">
            ‚ûï
        </button>
    </div>

    <div id="pointModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">

        <div class="bg-white rounded-lg w-[95%] max-w-md p-4 space-y-3">

            <h2 class="font-bold text-lg text-gray-800">
                Nuevo Punto
            </h2>
            <input type="hidden" id="clientId">

            <!-- BUSCADOR DE CLIENTES -->
            <div class="relative">
                <input id="clientSearch" class="w-full border rounded px-3 py-2 text-sm"
                    placeholder="üîç Buscar cliente por nombre o tel√©fono">

                <div id="clientResults"
                    class="absolute w-full bg-white border rounded mt-1 max-h-40 overflow-auto hidden z-50">
                </div>
            </div>



            <input id="clientName" class="w-full border rounded px-3 py-2 text-sm" placeholder="Nombre del cliente">

            <input id="clientPhone" class="w-full border rounded px-3 py-2 text-sm" placeholder="Tel√©fono del cliente">

            <input id="material" class="w-full border rounded px-3 py-2 text-sm" placeholder="Material interesado">

            <input id="closeDate" type="date" class="w-full border rounded px-3 py-2 text-sm">

            <textarea id="notes" rows="2" class="w-full border rounded px-3 py-2 text-sm"
                placeholder="Notas adicionales"></textarea>

            <button id="useLocationBtn" class="w-full py-2 text-sm rounded bg-gray-100 hover:bg-gray-200">
                üìç Usar mi ubicaci√≥n actual
            </button>

            <button id="selectMapBtn" class="w-full py-2 text-sm rounded bg-gray-100 hover:bg-gray-200">
                üó∫Ô∏è Seleccionar en el mapa
            </button>

            <div class="flex justify-end gap-2 pt-2">
                <button id="cancelBtn" class="text-sm px-3 py-2 text-gray-600">
                    Cancelar
                </button>
                <button id="savePointBtn" class="text-sm px-4 py-2 bg-indigo-600 text-white rounded">
                    Guardar
                </button>
            </div>

        </div>
    </div>



    <script>

        // ----------------------------------------------------
        // NAVBAR
        // ----------------------------------------------------
        const menuToggle = document.getElementById('menu-toggle');
        const mobileMenu = document.getElementById('mobile-menu');
        const iconMenu = document.getElementById('icon-menu');
        const iconClose = document.getElementById('icon-close');

        menuToggle.addEventListener('click', () => {
            const isExpanded = menuToggle.getAttribute('aria-expanded') === 'true';
            menuToggle.setAttribute('aria-expanded', !isExpanded);
            mobileMenu.classList.toggle('hidden');
            iconMenu.classList.toggle('hidden');
            iconClose.classList.toggle('hidden');
            document.body.classList.toggle('no-scroll', !isExpanded);
        });

        document.querySelectorAll('#mobile-menu a').forEach(link => {
            link.addEventListener('click', () => {
                if (!mobileMenu.classList.contains('hidden')) menuToggle.click();
            });
        });

        // ----------------------------------------------------
        // VARIABLES GLOBALES
        // ----------------------------------------------------
        let map;
        let selectedLatLng = null;
        let tempMarker = null;
        let selectingFromMap = false;
        let editingProjectId = null;

        const markersMap = new Map();

        // ----------------------------------------------------
        // MODAL
        // ----------------------------------------------------

        const clientSearchInput = document.getElementById('clientSearch');
        const clientResults = document.getElementById('clientResults');

        const clientNameInput = document.getElementById('clientName');
        const clientPhoneInput = document.getElementById('clientPhone');
        const clientIdInput = document.getElementById('clientId');
        clientSearchInput.addEventListener('input', () => {
            const query = clientSearchInput.value.toLowerCase().trim();
            clientResults.innerHTML = '';

            if (!query) {
                clientResults.classList.add('hidden');
                return;
            }

            const matches = getClients().filter(c =>
                `${c.name} ${c.lastname || ''} ${c.phone}`
                    .toLowerCase()
                    .includes(query)
            );

            if (!matches.length) {
                clientResults.innerHTML = `
            <div class="px-3 py-2 text-sm text-gray-500">
                Sin resultados
            </div>
        `;
                clientResults.classList.remove('hidden');
                return;
            }

            matches.forEach(client => {
                const item = document.createElement('div');
                item.className = 'px-3 py-2 text-sm hover:bg-gray-100 cursor-pointer';

                item.innerHTML = `
            <div class="font-medium">
                ${client.name} ${client.lastname || ''}
            </div>
            <div class="text-xs text-gray-500">
                üìû ${client.phone}
            </div>
        `;

                item.onclick = () => selectClient(client);
                clientResults.appendChild(item);
            });

            clientResults.classList.remove('hidden');
        });

        //BLOQUEAR PINCH ZOOM CON JS (CLAVE)
        let lastTouchEnd = 0;

// üö´ Bloquear doble tap zoom
document.addEventListener('touchend', function (event) {
    const now = new Date().getTime();
    if (now - lastTouchEnd <= 300) {
        event.preventDefault();
    }
    lastTouchEnd = now;
}, { passive: false });

// üö´ Bloquear pinch zoom
document.addEventListener('gesturestart', e => e.preventDefault());
document.addEventListener('gesturechange', e => e.preventDefault());
document.addEventListener('gestureend', e => e.preventDefault());



        function selectClient(client) {
            clientNameInput.value = `${client.name} ${client.lastname || ''}`.trim();
            clientPhoneInput.value = client.phone;
            clientIdInput.value = client.id;
            clientNameInput.dataset.address = client.address || '';

            clientResults.classList.add('hidden');
            clientSearchInput.value = '';
        }


        clientPhoneInput.addEventListener('blur', () => {
            const phone = clientPhoneInput.value.trim();
            if (!phone) return;

            const client = findClientByPhone(phone);

            if (client) {
                clientNameInput.value = `${client.name} ${client.lastname || ''}`.trim();
                clientPhoneInput.value = client.phone;
                clientIdInput.value = client.id;
                clientNameInput.dataset.address = client.address || '';
            } else {
                clientIdInput.value = '';
                clientNameInput.dataset.address = '';
            }
        });


        const modal = document.getElementById('pointModal');


        function resetModal() {
            // Inputs principales
            clientNameInput.value = '';
            clientPhoneInput.value = '';
            material.value = '';
            closeDate.value = '';
            notes.value = '';

            // Cliente vinculado
            clientIdInput.value = '';
            clientNameInput.dataset.address = '';

            // Buscador
            clientSearchInput.value = '';
            clientResults.innerHTML = '';
            clientResults.classList.add('hidden');

            // Estado del modal
            editingProjectId = null;
            selectedLatLng = null;

            // Limpia marcador temporal
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
        }


        function openModal() {
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            clientSearchInput.value = '';
            clientResults.classList.add('hidden');
                // üö´ Bloquear zoom del navegador
    document.body.classList.add('modal-open');

        }
        document.addEventListener('click', e => {
            if (!clientResults.contains(e.target) &&
                e.target !== clientSearchInput) {
                clientResults.classList.add('hidden');
            }
        });



function closeModal() {
    modal.classList.add('hidden');
    editingProjectId = null;

        // ‚úÖ Restaurar gestos normales
    document.body.classList.remove('modal-open');

    // üîß Forzar rec√°lculo del mapa (MUY IMPORTANTE)
    setTimeout(() => {
        map.invalidateSize();
    }, 200);
}


        // ----------------------------------------------------
        // MAPA
        // ----------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {

            map = L.map('map', {
                scrollWheelZoom: false, // ‚ùå evita zoom accidental
                touchZoom: true,        // ‚úÖ zoom con dedos
                dragging: true,         // ‚úÖ mover mapa
                tap: false              // ‚úÖ evita bugs en m√≥vil
            }).setView([13.80057, -88.86458], 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19
            }).addTo(map);

            map.on('click', onMapClick);

            loadProjects();
            resetModal();
        });

        // ----------------------------------------------------
        // CLICK EN MAPA
        // ----------------------------------------------------
        function onMapClick(e) {
            if (!selectingFromMap) return;

            selectedLatLng = e.latlng;

            if (tempMarker) map.removeLayer(tempMarker);
            tempMarker = L.marker(selectedLatLng).addTo(map);

            selectingFromMap = false;
            map.getContainer().style.cursor = '';

            openModal();
        }

        // ----------------------------------------------------
        // BOTONES MODAL
        // ----------------------------------------------------
        document.getElementById('openModalBtn').onclick = () => {
            resetModal();
            openModal();
        };

        document.getElementById('cancelBtn').onclick = () => {
            resetModal();
            closeModal();
        };

        // ----------------------------------------------------
        // UBICACI√ìN ACTUAL
        // ----------------------------------------------------
        document.getElementById('useLocationBtn').onclick = () => {
            navigator.geolocation.getCurrentPosition(pos => {
                selectedLatLng = {
                    lat: pos.coords.latitude,
                    lng: pos.coords.longitude
                };

                if (tempMarker) map.removeLayer(tempMarker);
                tempMarker = L.marker(selectedLatLng).addTo(map);

                map.setView(selectedLatLng, 17);
            });
        };

        // ----------------------------------------------------
        // SELECCIONAR EN MAPA
        // ----------------------------------------------------
        document.getElementById('selectMapBtn').onclick = () => {
            selectingFromMap = true;

            // üî¥ OCULTAR MARCADOR ORIGINAL SI SE EST√Å EDITANDO
            if (editingProjectId) {
                const marker = markersMap.get(editingProjectId);
                if (marker) {
                    marker.remove();
                }
            }

            closeModal();
            map.getContainer().style.cursor = 'crosshair';
        };


        // ----------------------------------------------------
        // FECHAS Y COLORES
        // ----------------------------------------------------
        function daysRemaining(dateString) {
            if (!dateString) return 0;

            const [y, m, d] = dateString.split('-').map(Number);

            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const target = new Date(y, m - 1, d);
            target.setHours(0, 0, 0, 0);

            return Math.round((target - today) / (1000 * 60 * 60 * 24));
        }

        function getMarkerColorByDays(days) {
            if (days > 16) return 'green';
            if (days >= 6) return 'orange';
            return 'red';
        }

        function getBadgeBg(color) {
            if (color === 'green') return '#bbf7d0';
            if (color === 'orange') return '#fed7aa';
            return '#fecaca';
        }

        // ----------------------------------------------------
        // LOCALSTORAGE
        // ----------------------------------------------------

        function getClients() {
            return JSON.parse(localStorage.getItem('clients') || '[]');
        }
        function findClientByPhone(phone) {
            const clean = phone.replace(/[^0-9]/g, '');
            return getClients().find(c =>
                c.phone && c.phone.replace(/[^0-9]/g, '') === clean
            );
        }



        function getStoredProjects() {
            return JSON.parse(localStorage.getItem('projects')) || [];
        }

        function saveProjects(projects) {
            localStorage.setItem('projects', JSON.stringify(projects));
        }

        // ----------------------------------------------------
        // CREAR MARKER + POPUP GRANDE
        // ----------------------------------------------------
        function createMarker(project) {
            const days = daysRemaining(project.closeDate);
            const color = getMarkerColorByDays(days);
            const badgeBg = getBadgeBg(color);

            const marker = L.circleMarker([project.lat, project.lng], {
                radius: 9,
                color,
                fillColor: color,
                fillOpacity: 0.9
            }).addTo(map);

            markersMap.set(project.id, marker);

            marker.bindPopup(`
        <div style="min-width:260px;font-family:Inter,sans-serif">
            
            <div style="
                background:${badgeBg};
                color:#000;
                padding:8px;
                border-radius:8px;
                font-weight:700;
                text-align:center;
                font-size:15px;
                margin-bottom:10px;">
                Faltan ${days} d√≠as
            </div>

            <div style="font-size:18px;font-weight:800;margin-bottom:8px">
                ${project.name}
            </div>

            <div style="margin-bottom:6px">
                üìû 
                <a href="tel:${project.phone}" style="color:#2563eb;font-weight:600">
                    Llamar
                </a>
                &nbsp;|&nbsp;
                <a href="https://wa.me/${project.phone.replace(/[^0-9]/g, '')}"
                   target="_blank"
                   style="color:#16a34a;font-weight:600">
                    WhatsApp
                </a>
            </div>

            <div style="margin-bottom:6px;font-size:14px">
                üß± ${project.material}
            </div>
            <div style="font-size:13px;color:#374151;margin-bottom:6px">
    üìç ${project.address || 'Sin direcci√≥n'}
</div>


            <div style="font-size:13px;color:#374151;margin-bottom:10px">
                üìù ${project.notes || 'Sin notas'}
            </div>

            <div style="display:flex;gap:8px">
                <button onclick="editProject(${project.id})"
                    style="flex:1;padding:6px;font-size:13px;
                    background:#2563eb;color:#fff;border-radius:6px">
                    Editar
                </button>

                <button onclick="deleteProject(${project.id})"
                    style="flex:1;padding:6px;font-size:13px;
                    background:#dc2626;color:#fff;border-radius:6px">
                    Eliminar
                </button>
            </div>
        </div>
    `);
        }

        // ----------------------------------------------------
        // CARGAR PROYECTOS
        // ----------------------------------------------------
        function loadProjects() {
            getStoredProjects().forEach(createMarker);
        }

        // ----------------------------------------------------
        // GUARDAR / EDITAR
        // ----------------------------------------------------
        document.getElementById('savePointBtn').onclick = () => {

            if (!selectedLatLng) {
                alert('Selecciona una ubicaci√≥n');
                return;
            }

            let projects = getStoredProjects();

            if (editingProjectId) {

                const index = projects.findIndex(p => p.id === editingProjectId);
                if (index === -1) return;

                // ACTUALIZAR DATOS DEL PROYECTO
                projects[index] = {
                    ...projects[index],
                    clientId: clientIdInput.value || null,
                    address: clientNameInput.dataset.address || '',
                    name: clientNameInput.value,
                    phone: clientPhoneInput.value,
                    material: material.value,
                    closeDate: closeDate.value,
                    notes: notes.value,
                    lat: selectedLatLng.lat,
                    lng: selectedLatLng.lng
                };

                // üî¥ ELIMINAR MARCADOR VIEJO (EVITA DUPLICADOS)
                const oldMarker = markersMap.get(editingProjectId);
                if (oldMarker) {
                    oldMarker.remove();
                    markersMap.delete(editingProjectId);
                }

                // üü¢ CREAR MARCADOR NUEVO CON DATOS ACTUALIZADOS
                createMarker(projects[index]);

            } else {

                const project = {
                    id: Date.now(),
                    clientId: clientIdInput.value || null,
                    address: clientNameInput.dataset.address || '',
                    name: clientNameInput.value,
                    phone: clientPhoneInput.value,
                    material: material.value,
                    closeDate: closeDate.value,
                    notes: notes.value,
                    lat: selectedLatLng.lat,
                    lng: selectedLatLng.lng,
                    createdAt: new Date().toISOString()
                };

                projects.push(project);
                createMarker(project);
            }

            saveProjects(projects);

            // LIMPIAR MARCADOR TEMPORAL
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }

            selectedLatLng = null;

            resetModal();
            closeModal();
        };



        // ----------------------------------------------------
        // EDITAR
        // ----------------------------------------------------
        window.editProject = function (id) {
            const project = getStoredProjects().find(p => p.id === id);
            if (!project) return;

            editingProjectId = id;
            selectedLatLng = { lat: project.lat, lng: project.lng };

            clientNameInput.value = project.name;
            clientPhoneInput.value = project.phone;
            material.value = project.material;
            closeDate.value = project.closeDate;
            notes.value = project.notes || '';
            clientIdInput.value = project.clientId || '';
            clientNameInput.dataset.address = project.address || '';

            openModal();
        };


        // ----------------------------------------------------
        // ELIMINAR
        // ----------------------------------------------------
        window.deleteProject = function (id) {
            let projects = getStoredProjects();
            projects = projects.filter(p => p.id !== id);
            saveProjects(projects);

            const marker = markersMap.get(id);
            if (marker) {
                marker.remove();
                markersMap.delete(id);
            }
        };

    </script>


</body>

</html>



